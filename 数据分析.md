import os
import re
from pyspark.sql import SparkSession
from pyspark.sql import functions as F
from pyspark.sql.window import Window
import pandas as pd

# 设置正确的Python解释器路径 (Windows需要指定python.exe)
os.environ['PYSPARK_PYTHON'] = 'python'  # 或者指定完整路径如'C:\\Python39\\python.exe'


def main():
    # 初始化SparkSession
    spark = SparkSession.builder \
        .appName("JD Mobile Analysis") \
        .config("spark.sql.legacy.timeParserPolicy", "LEGACY") \
        .config("spark.sql.execution.arrow.pyspark.enabled", "false") \
        .getOrCreate()

    # 1. 检查文件是否存在
    file_path = "京东手机数据.csv"
    if not os.path.exists(file_path):
        print(f"错误: 文件 '{file_path}' 不存在!")
        print(f"当前工作目录: {os.getcwd()}")
        print("请将文件放在当前目录或提供完整路径")
        spark.stop()
        return

    # 2. 读取CSV文件（兼容格式问题）
    try:
        # 首先使用pandas读取数据检查格式
        pdf = pd.read_csv(file_path, nrows=5)
        header = list(pdf.columns)

        # 判断分隔符：如果第一列有多个字段，可能是空格分隔
        if len(pdf.columns) == 1:
            print("检测到单一列，尝试空格分隔")
            df = spark.read.csv(file_path, sep=" ", header=True, inferSchema=True)
        else:
            df = spark.read.csv(file_path, header=True, inferSchema=True, multiLine=True)
    except Exception as e:
        print(f"文件读取错误: {str(e)}")
        spark.stop()
        return

    # 显示列名和数据预览
    print("\n=== 数据列名 ===")
    print(df.columns)

    print("\n=== 数据预览（前5行）===")
    df.show(5, truncate=50)

    # 3. 自动识别关键列
    title_col = next((col for col in df.columns if "title" in col.lower() or "名称" in col), "title")
    review_col = next((col for col in df.columns if "review" in col.lower() or "评价" in col or "销量" in col), None)
    brand_col = next((col for col in df.columns if "brand" in col.lower() or "品牌" in col), None)

    print(f"\n识别结果:")
    print(f"标题列: {title_col}")
    print(f"评价列: {review_col if review_col else '未找到，使用分组计数替代'}")
    print(f"品牌列: {brand_col if brand_col else '未找到，从标题提取'}")

    # 4. 品牌数量占比分析
    if brand_col:
        brand_df = df.select(brand_col).withColumnRenamed(brand_col, "brand")
    else:
        # 从标题提取品牌（取第一个单词）
        brand_df = df.withColumn("brand", F.regexp_extract(F.col(title_col), r'^(\S+)', 1))

    # 计算品牌占比
    total_count = brand_df.count()
    brand_stats = (brand_df
                   .groupBy("brand")
                   .agg(F.count("*").alias("count"))
                   .withColumn("percentage", F.round(F.col("count") / total_count * 100, 2))
                   .orderBy(F.col("count").desc())
                   )

    print("\n=== 不同手机品牌数量占比 ===")
    brand_stats.show(truncate=False)

    # 5. 关注度最高的手机型号分析
    # 方法1：有评价数据时优先使用
    if review_col:
        # 注册UDF处理评价数字
        def parse_reviews(text):
            if not text: return 0
            text = str(text).replace("+", "").replace(",", "")

            # 处理"万"单位
            if "万" in text:
                num = re.findall(r'(\d+\.?\d*)万', text)
                if num:
                    return int(float(num[0]) * 10000)

            # 提取纯数字
            nums = re.findall(r'\d+', text)
            return int(nums[0]) if nums else 0

        # 注册UDF
        parse_reviews_udf = F.udf(parse_reviews, "bigint")

        # 计算每个型号的评价/销量总数
        top_models = (df
                      .withColumn("review_count", parse_reviews_udf(F.col(review_col)))
                      .groupBy(title_col)
                      .agg(F.sum("review_count").alias("total_reviews"))
                      .orderBy(F.col("total_reviews").desc())
                      .limit(10)
                      )

        print("\n=== 关注度最高的手机型号（基于评价/销量）===")
        top_models.show(truncate=False)

    # 方法2：没有评价数据时使用分组计数作为热度指标
    else:
        top_models = (df
                      .groupBy(title_col)
                      .agg(F.count("*").alias("count"))
                      .orderBy(F.col("count").desc())
                      .limit(10)
                      )

        print("\n=== 最受欢迎的手机型号（基于出现频次）===")
        top_models.show(truncate=False)

    # 6. 结果保存（可选）
    try:
        brand_stats.coalesce(1).write.mode("overwrite").csv("品牌占比结果", header=True)
        top_models.coalesce(1).write.mode("overwrite").csv("热门机型结果", header=True)
        print("结果已保存到CSV文件")
    except:
        print("结果保存失败，请手动复制控制台输出")

    spark.stop()


if __name__ == "__main__":
    main()
